# نظرة عامة سريعة
نطاق هذا المستند: تعريف شامل لنظام نقاط بيع (POS) متعدد الفروع والمخازن، متكامل مع إدارة مخزون كاملة، مرتجعات، مشتريات، محاسبة أساسية (General Ledger + سندات صرف/قبض)، تقارير ولوحات، أمان متقدم (2FA + بايومتريك + سجلات)، طباعة ومشاركة فواتير، وضع عدم الاتصال والمزامنة، وتكامل بوابة دفع. يشمل معايير القبول، خطة التنفيذ، الاختبارات، والتسليمات.

---

## 1) النطاق الوظيفي (Functional Scope)
### 1.1 المبيعات (واجهة الصراف)
- تسجيل دخول الصراف (هاتف/تابلت/كمبيوتر) مع دعم البصمة/الوجه.
- مسح باركود بالكاميرا + إدخال يدوي + "بيع سريع" بدون أصناف.
- سلة واضحة (إضافة/تعديل كمية/حذف سطر، خصم بالسقف المسموح).
- تعدد العملات والضرائب والحساب الدقيق للإجمالي.
- طرق الدفع: نقد، محفظة إلكترونية، بطاقة، آجل/تقسيط (مع حدود ائتمانية وقواعد صلاحية).
- إنهاء البيع بإصدار فاتورة: طباعة Bluetooth، مشاركة إلكترونية (واتساب/إيميل).
- فواتير معلّقة واستئنافها، التقارير اليومية للصراف.
- إشعارات ذكية داخل الواجهة (رفض دفع، تنبيه مخزون منخفض، تقدّم الهدف اليومي...).

### 1.2 المرتجعات
- البحث عن الفاتورة الأصلية (رقم/عميل/تاريخ) + عرض تفاصيلها.
- إرجاع كلي/جزئي مع اختيار السبب، سياسات زمنية وقواعد استثناء.
- تحديث المخزون (إعادة للمخزون أو تحويل لقسم مخصّص) مع سجلات كاملة.
- ردّ المبلغ: نقد/إرجاع لنفس البطاقة/إضافة رصيد للمحفظة/استبدال.
- إصدار إيصال إرجاع ومشاركة إلكترونية.

### 1.3 المنتجات والمخزون
- إدارة المنتجات (اسم/باركود/سعر/ضريبة/وحدات/صور/متغيرات)، مجموعات وفئات.
- مخازن متعددة، تحويلات بين المخازن، جرد دوري/مفاجئ، تسويات فروقات.
- حركة مخزون تفصيلية (IN/OUT/Adjust/Return/Transfer/Write‑off).
- حد إعادة الطلب، تنبيهات نفاد/انخفاض المخزون.

### 1.4 المشتريات والموردون
- فواتير مشتريات محلية، موردون، شروط دفع وحدود ائتمان.
- إدخال تكاليف إضافية (شحن/رسوم) وانعكاسها على تكلفة المخزون.
- تسوية دفعات الموردين، متابعة المستحقات.

### 1.5 العملاء والولاء
- إضافة عملاء وإدارة بياناتهم، حدود ائتمان، أرصدة محفظة/نقاط (أساسيات).
- سجل تعاملات العميل (مبيعات/مرتجعات/مديونيات).

### 1.6 المحاسبة الأساسية (General Ledger)
- دليل حسابات (أصول/التزامات/إيرادات/مصاريف) وقابلية التخصيص.
- قيود يومية، سندات صرف/قبض، ترحيل تلقائي لحركات المبيعات/المرتجعات/الدفعات.
- إقفال فترات محاسبية لمنع التعديل.

### 1.7 المستخدمون والصلاحيات (RBAC)
- أدوار: مدير نظام/نائب مدير/محاسب/أمين مخزن/صراف ... إلخ.
- ربط مستخدم بفرع/مخزن وتحديد صلاحيات دقيقة لكل شاشة/عملية.

### 1.8 الفروع والتقارير
- إدارة الفروع والتبديل بينها، تقارير موحّدة عبر الفروع.
- لوحة مؤشرات تفاعلية: إجمالي المبيعات، أفضل المنتجات، سلاسل زمنية، مقارنة الفترات.
- تقارير: صندوق، مبيعات، مرتجعات، مخزون، موردين، عملاء، ربحية الصنف/الفئة، رصيد الميزانية.
- تصدير PDF/Excel والمشاركة (بريد/واتساب).

### 1.9 الطباعة والمشاركة
- طباعة حرارية عبر Bluetooth/USB (عبر Web + Bridge صغير إن لزم) مع قوالب عربية/إنجليزية.
- فواتير إلكترونية: QR/باركود للفاتورة، روابط مشاركة.

### 1.10 الأمان والحَوْكمة
- 2FA (SMS/Authenticator) + بايومتريك (WebAuthn للأجهزة الداعمة).
- سياسات كلمة مرور، قفل الحساب عند محاولات فاشلة، انتهاء جلسة الخمول.
- سجلات دقيقة (من/متى/ماذا/قبل-بعد)، تتبع الجلسات، تتبّع تغييرات الحساسة.

### 1.11 وضع عدم الاتصال (Offline‑First)
- استمرار البيع دون إنترنت: قائمة منتجات/أسعار/ضرائب/مخزون محلي مُخزّن مؤقتاً.
- طابور تغييرات محلي، مزامنة تلقائية عند الاتصال مع حلّ تعارضات (آخر تعديل موثّق وسياسات دمج).

### 1.12 التكاملات
- بوابة دفع واحدة كبداية (بطاقة/محفظة)، مزوّد رسائل (OTP/SMS/واتساب)، بريد إلكتروني.

---

## 2) نطاق غير وظيفي (NFR)
- الأداء: البحث/الإضافة ≤ 2–3 ث، طباعة فورية، تحميل لوحة الصراف ≤ 2 ث على أجهزة متوسطة.
- الأمان: TLS، تشفير بيانات حساسة، Least‑Privilege، مراجعة صلاحيات، Journaled Audit.
- الاعتمادية: نسخ احتياطي مجدول + اختبار استعادة دوري، مراقبة/تنبيهات، RPO≤24h، RTO≤4h.
- القابلية للتوسع: تعدد الفروع والمستخدمين، فصل الخدمات الحرجة (Auth/Payments/Sync).
- قابلية التشغيل: سجل أخطاء، تتبّع، مقاييس (APM/Logs/Dashboards)، تنبيهات فشل النسخ.
- قابلية الوصول والتعريب: RTL/عربي/إنجليزي، أرقام عملات محلية.

---

## 3) نموذج البيانات (عالي المستوى)
**كيانات أساسية:** Users, Roles, Branches, Warehouses, Products, ProductVariants, Categories, PriceLists, Taxes, Currencies, StockItems, StockMovements, Suppliers, PurchaseInvoices, Customers, SalesInvoices, Payments, Returns, CreditNotes, GLAccounts, JournalEntries, Receipts, Disbursements, AuditLogs, SyncBatches.

**علاقات مختصرة:**
- Branch 1‑* Warehouse 1‑* StockItems.
- Product 1‑* Variants؛ Variant *‑* Warehouse عبر StockItems.
- SalesInvoice *‑* Payments؛ SalesInvoice 1‑* InvoiceLines (منتج/كمية/سعر/ضريبة/خصم).
- Return -> SalesInvoice (مرجع) + StockMovement (+/‑) + Payment/Wallet/CreditNote.
- JournalEntryLines ترتبط آلياً بقيود من المبيعات/المرتجعات/الدفعات.

---

## 4) واجهات المستخدم الرئيسية
### 4.1 الصراف
- لوحة اليوم + هدف/مؤشر، مسح باركود، بيع سريع، سلة، أزرار دفع ملونة، تقرير يومي.

### 4.2 المرتجعات
- شاشة بحث عن الفاتورة + اختيار أصناف/كميات + سبب + معالجة مالية + إيصال.

### 4.3 لوحة المدير
- لوحة مؤشرات، المستخدمون والصلاحيات، الفروع/المخازن، الكتالوج والأسعار والضرائب، المشتريات، التقارير، النسخ الاحتياطي/الاختبار.

---

## 5) معايير القبول (Per Feature)
### المبيعات
- [AC‑S1] مسح باركود يضيف السطر خلال ≤ 1.5 ث.
- [AC‑S2] منع إضافة كمية أكبر من المتاح مع تنبيه واضح.
- [AC‑S3] خصم لا يتجاوز الحد المسموح إلا بتفويض مدير.
- [AC‑S4] دعم نقد/بطاقة/محفظة/آجل مع توثيق مرجع المعاملة وفشل/نجاح واضح.
- [AC‑S5] فاتورة PDF/حرارية بعرض عربي صحيح + مشاركة إلكترونية.

### المرتجعات
- [AC‑R1] البحث بالرقم/العميل/التاريخ خلال ≤ 3 ث وعرض تفاصيل الفاتورة.
- [AC‑R2] إرجاع كلي/جزئي مع سبب إلزامي وتحديث مخزون فوري وسجل عمليات.
- [AC‑R3] ردّ المبلغ أو الاستبدال أو رصيد المحفظة حسب السياسة.

### المخزون
- [AC‑I1] كل حركة مخزون تُسجّل بنوعها ومرجعها ومَن قام بها.
- [AC‑I2] تنبيه حد إعادة الطلب يُرسل للإشعارات والمدير.

### المشتريات
- [AC‑P1] إنشاء فاتورة مورد مع تكلفة إضافية وتحديث التكلفة المتوسطة.
- [AC‑P2] تسوية دفعات المورد وعكسها في الأستاذ العام.

### المحاسبة
- [AC‑A1] دليل حسابات قابل للتخصيص.
- [AC‑A2] قيود تلقائية عند: بيع/مرتجع/دفع/سداد/مشتريات.
- [AC‑A3] قفل فترة يمنع التعديلات الرجعية.

### الأمان/النسخ/الفروع
- [AC‑SEC1] 2FA + بايومتريك للأجهزة الداعمة، قفل عند محاولات فاشلة.
- [AC‑BKP1] جدولة نسخ يومي/أسبوعي/شهري + اختبار استعادة.
- [AC‑BR1] تقارير موحّدة عبر الفروع + تبديل سريع.

### Offline
- [AC‑OFF1] استمرار البيع دون إنترنت وتخزين كل الحركات مؤقتاً.
- [AC‑OFF2] مزامنة تلقائية عند عودة الاتصال مع حل تعارضات موثّق.

---

## 6) خطة التنفيذ والجدولة (يشمل كل شيء)
> خطة 14 أسبوعاً (≈ 70 أيام عمل) لفريق 2 فل‑ستاك + QA جزئي، تشمل المحاسبة + Offline.

**الأسبوع 1–2 — الأساس والأمان:**
- إعداد المشروع، المصادقة، RBAC، 2FA، سجلات، معايير تصميم واجهات.

**الأسبوع 3 — الكتالوج/الضرائب/العملات:**
- كيانات المنتجات/الفئات/الأسعار/الضرائب/العملات + CRUD + استيراد CSV.

**الأسبوع 4–5 — المبيعات (POS):**
- شاشة الصراف، مسح باركود/إدخال يدوي/بيع سريع، خصومات، دفعات نقد/محفظة/بطاقة، طباعة/مشاركة.

**الأسبوع 6 — المرتجعات:**
- رحلة الإرجاع الكاملة + إيصال الإرجاع.

**الأسبوع 7 — المخزون:**
- حركة مخزون/تنبيهات/جرد/تحويلات.

**الأسبوع 8 — المشتريات والموردون:**
- فواتير الموردين/شروط الدفع/التسويات.

**الأسبوع 9–10 — المحاسبة الأساسية:**
- دليل حسابات/قيود/سندات/ترحيل تلقائي/تقارير محاسبية.

**الأسبوع 11 — الفروع والتقارير:**
- إدارة الفروع، التقارير الموحدة، لوحة مؤشرات.

**الأسبوع 12–13 — Offline‑First والمزامنة:**
- طبقة التخزين المحلي والطوابير، حل التعارضات، اختبارات بدون إنترنت.

**الأسبوع 14 — الصقل/الأداء/الأمان/DR:**
- تحسينات، ضغط/كاش/مؤشرات، نسخ احتياطي واختبار استعادة، تثبيت الإصدارات، جاهزية الإطلاق.

> **هوامش مخاطرة**: التوسع في التكاملات أو مزوّد الدفع قد يضيف 1–2 أسبوع. الطباعة الحرارية عبر الويب قد تتطلب Bridge بسيط.

---

## 7) التسليمات
- كود المصدر (Backend + Frontend PWA + Bridge طباعة عند الحاجة).
- مستندات: BRD/SRS، دليل حسابات افتراضي، سياسات الخصم/الإرجاع، ERD عالي المستوى.
- قوالب تقارير وفواتير (PDF/حراري)، ملفات ترجمة (ar/en).
- CI/CD، Runbooks للنسخ الاحتياطي/الاستعادة والمراقبة.
- حِزمة اختبارات (وحدات/تكامل/E2E) وتقارير تغطية ≥ 70% مبدئياً.

---

## 8) الافتراضات/القيود
- مزوّد دفع واحد في الإصدار الأول.
- الأجهزة: متصفحات حديثة + أندرويد (Chrome) لطباعة Bluetooth.
- السعة: حتى 10 فروع في الإطلاق الأول (قابلة للتوسّع).

---

## 9) المخاطر والتخفيف
- **اتصال ضعيف**: Offline‑First + إعادة محاولات + مؤشرات حالة المزامنة.
- **طباعة حرارية**: استخدام ESC/POS عبر WebUSB/Bluetooth أو Bridge سطح مكتب.
- **سياسات الإرجاع المعقدة**: تصميم قواعد قابلة للتكوين + سجلات دقيقة.
- **التكاملات**: عزل مزوّد الدفع في Adapter مع اختبارات عقدية.

---

## 10) خطة الاختبارات والجودة
- وحدات (خاصة الحسابات/الضرائب/التسعير/التخفيض)، تكامل (POS↔Inventory↔GL↔Payments)، E2E (سيناريو الصراف/الإرجاع/المشتريات/التقارير/الإقفال)، اختبارات Offline ومزامنة، أداء (100 فطرة/دقيقة/جهاز)، أمان (JWT/CSRF/Rate‑Limit/Bruteforce/Permissions)، طباعة/قوالب PDF RTL.

---

## 11) بنية تقنية مُقترحة (مثال مرجعي)
- Backend: NestJS, PostgreSQL, Redis (Queues/Cache), Prisma/TypeORM, OpenAPI, Keycloak/2FA أو WebAuthn.
- Frontend: React (PWA), IndexedDB للتخزين المحلي, Camera API/Barcode, WebBluetooth/WebUSB.
- مزامنة: Job Queue + Conflict Resolver + Change Feed.
- ملاحظة: قابل للتبديل وفق تفضيلاتك.

---

## 12) معايير الإطلاق (Go/No‑Go)
- اجتياز جميع ACs، تغطية ≥70%، متوسط زمن شاشة الصراف ≤ 2 ث، طباعة/مشاركة تعمل، تقارير أساسية سليمة، نجاح اختبار الاستعادة، مراقبة/تنبيهات مفعّلة.

---

## 13) قائمة قرارات (Defaults إن لم يُذكر خلاف ذلك)
- بوابة الدفع: اختيار واحد افتراضي (يُحدد لاحقاً)؛ دعم محفظة/بطاقة.
- الطباعة: تمكين Bluetooth + WebUSB؛ Bridge اختياري لأجهزة سطح المكتب.
- Offline: مفعّل من الإصدار الأول.
- المحاسبة: مفعّلة (GL/سندات/ترحيل تلقائي/إقفال فترات).

---

## 14) خطة تسليم وثائق العميل
- SOW/BRD النهائي PDF، كتيّب مستخدم الصراف/المدير، دليل تقني مختصر للتشغيل (DevOps/DR/Monitoring)، وجلسة تدريب (2 ساعة) تسجيل فيديو.

