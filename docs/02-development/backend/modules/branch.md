# ๐ข ูุญุฏุฉ ุงููุฑูุน (Branch Module)

## ูุธุฑุฉ ุนุงูุฉ

ูุญุฏุฉ ุงููุฑูุน ูุณุคููุฉ ุนู ุฅุฏุงุฑุฉ ูุฑูุน ุงูุดุฑูุฉ ูู ุงููุธุงู. ุชููุฑ ูุฐู ุงููุญุฏุฉ ูุธุงุฆู ุดุงููุฉ ูุฅูุดุงุก ูุชุญุฏูุซ ูุญุฐู ุงููุฑูุนุ ุจุงูุฅุถุงูุฉ ุฅูู ุฅุฏุงุฑุฉ ุนูุงูุงุชูุง ูุน ุงูุดุฑูุงุช ูุงููุณุชุฎุฏููู ูุงููุฎุงุฒู.

### ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

- **ุฅุฏุงุฑุฉ ุงููุฑูุน**: ุฅูุดุงุก ูุชุญุฏูุซ ูุญุฐู ุงููุฑูุน
- **ุฅุฏุงุฑุฉ ุงูุนูุงูุงุช**: ุฑุจุท ุงููุฑูุน ุจุงูุดุฑูุงุช ูุงููุณุชุฎุฏููู ูุงููุฎุงุฒู
- **ุงูุฅุญุตุงุฆูุงุช**: ุฅุญุตุงุฆูุงุช ุดุงููุฉ ุนู ุงููุฑูุน
- **ุงูููุชุฑุฉ**: ุงูุจุญุซ ุนู ุงููุฑูุน ุญุณุจ ุงูุดุฑูุฉ

### ุงูุงุนุชูุงุฏูุงุช

- `PrismaService`: ูููุตูู ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `CacheService`: ูุชุฎุฒูู ุงูุจูุงูุงุช ูู ุงููุงุด
- `UserModule`: ููุชุญูู ูู ุตุญุฉ ุงููุณุชุฎุฏููู (ุงููุฏูุฑูู)

---

## API Endpoints

### ุฅุฏุงุฑุฉ ุงููุฑูุน

#### POST `/branches`
ุฅูุดุงุก ูุฑุน ุฌุฏูุฏ

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.manage`

**Request Body**:
```json
{
  "name": "ุงููุฑุน ุงูุฑุฆูุณู",
  "code": "BR001",
  "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู",
  "phone": "+967712345678",
  "email": "branch1@example.com",
  "companyId": "clx1111111111",
  "managerId": "clx2222222222",
  "isActive": true
}
```

**Response** (201 Created):
```json
{
  "id": "clx3333333333",
  "name": "ุงููุฑุน ุงูุฑุฆูุณู",
  "code": "BR001",
  "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู",
  "phone": "+967712345678",
  "email": "branch1@example.com",
  "managerId": "clx2222222222",
  "companyId": "clx1111111111",
  "isActive": true,
  "company": {
    "id": "clx1111111111",
    "name": "ุดุฑูุฉ BThwani"
  },
  "warehouseCount": 0,
  "userCount": 0,
  "createdAt": "2025-12-01T10:00:00.000Z",
  "updatedAt": "2025-12-01T10:00:00.000Z"
}
```

**ุงูุฃุฎุทุงุก ุงููุญุชููุฉ**:
- `409 Conflict`: ููุฏ ุงููุฑุน ููุฌูุฏ ุจุงููุนู
- `404 Not Found`: ุงูุดุฑูุฉ ุบูุฑ ููุฌูุฏุฉ
- `404 Not Found`: ุงููุฏูุฑ ุบูุฑ ููุฌูุฏ

---

#### GET `/branches`
ุงูุญุตูู ุนูู ุฌููุน ุงููุฑูุน

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.read`

**Query Parameters**:
- `companyId` (optional): ููุชุฑุฉ ุญุณุจ ุงูุดุฑูุฉ

**Response** (200 OK):
```json
[
  {
    "id": "clx3333333333",
    "name": "ุงููุฑุน ุงูุฑุฆูุณู",
    "code": "BR001",
    "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู",
    "phone": "+967712345678",
    "email": "branch1@example.com",
    "managerId": "clx2222222222",
    "companyId": "clx1111111111",
    "isActive": true,
    "company": {
      "id": "clx1111111111",
      "name": "ุดุฑูุฉ BThwani"
    },
    "warehouseCount": 2,
    "userCount": 10,
    "createdAt": "2025-01-01T00:00:00.000Z",
    "updatedAt": "2025-12-01T10:00:00.000Z"
  }
]
```

---

#### GET `/branches/stats`
ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงููุฑูุน

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.read`

**Response** (200 OK):
```json
{
  "totalBranches": 5,
  "activeBranches": 4,
  "inactiveBranches": 1,
  "totalUsers": 50,
  "totalWarehouses": 10,
  "branchesByCompany": {
    "ุดุฑูุฉ BThwani": 5
  }
}
```

---

#### GET `/branches/:id`
ุงูุญุตูู ุนูู ูุฑุน ุจุงููุนุฑู

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.read`

**Response** (200 OK):
```json
{
  "id": "clx3333333333",
  "name": "ุงููุฑุน ุงูุฑุฆูุณู",
  "code": "BR001",
  "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู",
  "phone": "+967712345678",
  "email": "branch1@example.com",
  "managerId": "clx2222222222",
  "companyId": "clx1111111111",
  "isActive": true,
  "company": {
    "id": "clx1111111111",
    "name": "ุดุฑูุฉ BThwani",
    "description": "ุดุฑูุฉ ุชุฌุงุฑูุฉ"
  },
  "warehouseCount": 2,
  "userCount": 10,
  "createdAt": "2025-01-01T00:00:00.000Z",
  "updatedAt": "2025-12-01T10:00:00.000Z"
}
```

**ุงูุฃุฎุทุงุก ุงููุญุชููุฉ**:
- `404 Not Found`: ุงููุฑุน ุบูุฑ ููุฌูุฏ

---

#### GET `/branches/:id/users`
ุงูุญุตูู ุนูู ุงููุณุชุฎุฏููู ุจุงููุฑุน

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `users.read`

**Response** (200 OK):
```json
[
  {
    "id": "clx4444444444",
    "username": "cashier1",
    "email": "cashier1@example.com",
    "isActive": true,
    "role": {
      "id": "clx5555555555",
      "name": "cashier"
    }
  }
]
```

---

#### PATCH `/branches/:id`
ุชุญุฏูุซ ูุฑุน

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.manage`

**Request Body**:
```json
{
  "name": "ุงููุฑุน ุงูุฑุฆูุณู - ูุญุฏุซ",
  "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู - ูุญุฏุซ",
  "phone": "+967798765432",
  "managerId": "clx6666666666"
}
```

**Response** (200 OK):
```json
{
  "id": "clx3333333333",
  "name": "ุงููุฑุน ุงูุฑุฆูุณู - ูุญุฏุซ",
  "code": "BR001",
  "address": "ุตูุนุงุกุ ุดุงุฑุน ุงูุฒุจูุฑู - ูุญุฏุซ",
  "phone": "+967798765432",
  "managerId": "clx6666666666",
  "updatedAt": "2025-12-01T11:00:00.000Z"
}
```

**ุงูุฃุฎุทุงุก ุงููุญุชููุฉ**:
- `404 Not Found`: ุงููุฑุน ุบูุฑ ููุฌูุฏ
- `404 Not Found`: ุงููุฏูุฑ ุบูุฑ ููุฌูุฏ

---

#### DELETE `/branches/:id`
ุญุฐู ูุฑุน

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: `branches.manage`

**Response** (200 OK):
```json
{
  "message": "ุชู ุญุฐู ุงููุฑุน ุจูุฌุงุญ"
}
```

**ุงูุฃุฎุทุงุก ุงููุญุชููุฉ**:
- `404 Not Found`: ุงููุฑุน ุบูุฑ ููุฌูุฏ
- `400 Bad Request`: ูุง ูููู ุญุฐู ุงููุฑุน ูุฃูู ูุฑุชุจุท ุจุจูุงูุงุช ุฃุฎุฑู

---

## DTOs (Data Transfer Objects)

### CreateBranchDto
```typescript
{
  name: string;          // ุงุณู ุงููุฑุน (ูุทููุจุ ุญุฏ ุฃูุตู 255 ุญุฑู)
  code: string;          // ููุฏ ุงููุฑุน (ูุทููุจุ ูุฑูุฏุ ุญุฏ ุฃูุตู 50 ุญุฑู)
  address?: string;      // ุงูุนููุงู (ุงุฎุชูุงุฑู)
  phone?: string;        // ุฑูู ุงููุงุชู (ุงุฎุชูุงุฑูุ ุญุฏ ุฃูุตู 50 ุญุฑู)
  email?: string;        // ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุฎุชูุงุฑูุ ุตูุบุฉ ุตุญูุญุฉ)
  companyId: string;     // ูุนุฑู ุงูุดุฑูุฉ (ูุทููุจุ UUID)
  managerId?: string;    // ูุนุฑู ุงููุฏูุฑ (ุงุฎุชูุงุฑูุ UUID)
  isActive?: boolean;    // ุญุงูุฉ ุงููุดุงุท (ุงูุชุฑุงุถู: true)
}
```

**ููุงุนุฏ ุงูุชุญูู**:
- `name`: ูุทููุจุ ูุตุ ุญุฏ ุฃูุตู 255 ุญุฑู
- `code`: ูุทููุจุ ูุตุ ูุฑูุฏุ ุญุฏ ุฃูุตู 50 ุญุฑู
- `address`: ุงุฎุชูุงุฑูุ ูุต
- `phone`: ุงุฎุชูุงุฑูุ ูุตุ ุญุฏ ุฃูุตู 50 ุญุฑู
- `email`: ุงุฎุชูุงุฑูุ ุจุฑูุฏ ุฅููุชุฑููู ุตุญูุญ
- `companyId`: ูุทููุจุ UUID ุตุญูุญ
- `managerId`: ุงุฎุชูุงุฑูุ UUID ุตุญูุญ
- `isActive`: ุงุฎุชูุงุฑูุ ูููุฉ ููุทููุฉ

---

### UpdateBranchDto
```typescript
{
  name?: string;         // ุงุณู ุงููุฑุน
  address?: string;      // ุงูุนููุงู
  phone?: string;        // ุฑูู ุงููุงุชู
  email?: string;        // ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  managerId?: string;    // ูุนุฑู ุงููุฏูุฑ
  isActive?: boolean;    // ุญุงูุฉ ุงููุดุงุท
}
```

**ููุงุนุฏ ุงูุชุญูู**:
- ุฌููุน ุงูุญููู ุงุฎุชูุงุฑูุฉ
- `email`: ุฅุฐุง ุชู ุชูููุฑูุ ูุฌุจ ุฃู ูููู ุจุฑูุฏ ุฅููุชุฑููู ุตุญูุญ
- `managerId`: ุฅุฐุง ุชู ุชูููุฑูุ ูุฌุจ ุฃู ูููู UUID ุตุญูุญ

---

## ุงูุฎุฏูุงุช (Services)

### BranchService

#### `create(createBranchDto: CreateBranchDto): Promise<BranchWithDetails>`
ุฅูุดุงุก ูุฑุน ุฌุฏูุฏ

**ุงููุนุงููุงุช**:
- `createBranchDto`: ุจูุงูุงุช ุฅูุดุงุก ุงููุฑุน

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ุงููุฑุน ุงููููุดุฃ ูุน ุงูุชูุงุตูู

**ุงูุงุณุชุซูุงุกุงุช**:
- `ConflictException`: ุฅุฐุง ูุงู ููุฏ ุงููุฑุน ููุฌูุฏุงู
- `NotFoundException`: ุฅุฐุง ูุงูุช ุงูุดุฑูุฉ ุฃู ุงููุฏูุฑ ุบูุฑ ููุฌูุฏ

---

#### `findAll(companyId?: string): Promise<BranchWithDetails[]>`
ุงูุญุตูู ุนูู ุฌููุน ุงููุฑูุน ูุน ุงูููุชุฑุฉ

**ุงููุนุงููุงุช**:
- `companyId`: ูุนุฑู ุงูุดุฑูุฉ (ุงุฎุชูุงุฑู)

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ูุตูููุฉ ูู ุงููุฑูุน

---

#### `findOne(id: string): Promise<BranchWithDetails>`
ุงูุญุตูู ุนูู ูุฑุน ุจุงููุนุฑู

**ุงููุนุงููุงุช**:
- `id`: ูุนุฑู ุงููุฑุน

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ุงููุฑุน

**ุงูุงุณุชุซูุงุกุงุช**:
- `NotFoundException`: ุฅุฐุง ูุงู ุงููุฑุน ุบูุฑ ููุฌูุฏ

---

#### `update(id: string, updateBranchDto: UpdateBranchDto): Promise<BranchWithDetails>`
ุชุญุฏูุซ ูุฑุน

**ุงููุนุงููุงุช**:
- `id`: ูุนุฑู ุงููุฑุน
- `updateBranchDto`: ุจูุงูุงุช ุงูุชุญุฏูุซ

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ุงููุฑุน ุงููุญุฏุซ

**ุงูุงุณุชุซูุงุกุงุช**:
- `NotFoundException`: ุฅุฐุง ูุงู ุงููุฑุน ุฃู ุงููุฏูุฑ ุบูุฑ ููุฌูุฏ

---

#### `remove(id: string): Promise<void>`
ุญุฐู ูุฑุน

**ุงููุนุงููุงุช**:
- `id`: ูุนุฑู ุงููุฑุน

**ุงูุงุณุชุซูุงุกุงุช**:
- `NotFoundException`: ุฅุฐุง ูุงู ุงููุฑุน ุบูุฑ ููุฌูุฏ
- `BadRequestException`: ุฅุฐุง ูุงู ุงููุฑุน ูุฑุชุจุท ุจุจูุงูุงุช ุฃุฎุฑู

---

#### `getUsersByBranch(id: string): Promise<User[]>`
ุงูุญุตูู ุนูู ุงููุณุชุฎุฏููู ุจุงููุฑุน

**ุงููุนุงููุงุช**:
- `id`: ูุนุฑู ุงููุฑุน

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ูุตูููุฉ ูู ุงููุณุชุฎุฏููู

---

#### `getBranchStats(): Promise<BranchStats>`
ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงููุฑูุน

**ุงููููุฉ ุงููุฑุฌุนุฉ**: ุฅุญุตุงุฆูุงุช ุงููุฑูุน

---

## ุงูุนูุงูุงุช (Relationships)

### ุงููุญุฏุงุช ุงููุฑุชุจุทุฉ

- **Company**: ุงููุฑูุน ุชูุชูู ุฅูู ุดุฑูุฉ
- **User Module**: ุงููุฑูุน ูุฏููุง ูุณุชุฎุฏููู ููุฏูุฑูู
- **Warehouse Module**: ุงููุฑูุน ูุฏููุง ูุฎุงุฒู
- **Sales Module**: ุงููุฑูุน ูุฑุชุจุทุฉ ุจููุงุชูุฑ ุงููุจูุนุงุช
- **Audit Module**: ุฌููุน ุนูููุงุช ุงููุฑูุน ุชูุณุฌู ูู ุณุฌูุงุช ุงูุชุฏููู

### ุงูุชุจุนูุงุช

- `PrismaService`: ูููุตูู ุฅูู ุฌุฏุงูู `branches`, `companies`, `users`
- `CacheService`: ูุชุฎุฒูู ุงูุจูุงูุงุช ูู ุงููุงุด
- `UserModule`: ููุชุญูู ูู ุตุญุฉ ุงููุณุชุฎุฏููู (ุงููุฏูุฑูู)

### ุงูุฌุฏุงูู ุงููุฑุชุจุทุฉ

- `branches`: ุฌุฏูู ุงููุฑูุน ุงูุฑุฆูุณู
- `companies`: ุฌุฏูู ุงูุดุฑูุงุช
- `users`: ุฌุฏูู ุงููุณุชุฎุฏููู
- `warehouses`: ุฌุฏูู ุงููุฎุงุฒู
- `sales_invoices`: ููุงุชูุฑ ุงููุจูุนุงุช
- `audit_logs`: ุณุฌูุงุช ุงูุชุฏููู

---

## ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ูุซุงู 1: ุฅูุดุงุก ูุฑุน ุฌุฏูุฏ

```typescript
// Request
POST /branches
Authorization: Bearer <access_token>
{
  "name": "ุงููุฑุน ุงูุซุงูู",
  "code": "BR002",
  "address": "ุนุฏูุ ุดุงุฑุน ุงูุฌูููุฑูุฉ",
  "phone": "+967712345679",
  "email": "branch2@example.com",
  "companyId": "clx1111111111",
  "managerId": "clx2222222222",
  "isActive": true
}

// Response
{
  "id": "clx7777777777",
  "name": "ุงููุฑุน ุงูุซุงูู",
  "code": "BR002",
  "address": "ุนุฏูุ ุดุงุฑุน ุงูุฌูููุฑูุฉ",
  "phone": "+967712345679",
  "email": "branch2@example.com",
  "company": {
    "id": "clx1111111111",
    "name": "ุดุฑูุฉ BThwani"
  },
  "warehouseCount": 0,
  "userCount": 0,
  "createdAt": "2025-12-01T10:00:00.000Z"
}
```

### ูุซุงู 2: ุงูุจุญุซ ุนู ุงููุฑูุน ุญุณุจ ุงูุดุฑูุฉ

```typescript
// Request
GET /branches?companyId=clx1111111111
Authorization: Bearer <access_token>

// Response
[
  {
    "id": "clx3333333333",
    "name": "ุงููุฑุน ุงูุฑุฆูุณู",
    "code": "BR001",
    "company": {
      "id": "clx1111111111",
      "name": "ุดุฑูุฉ BThwani"
    }
  },
  {
    "id": "clx7777777777",
    "name": "ุงููุฑุน ุงูุซุงูู",
    "code": "BR002",
    "company": {
      "id": "clx1111111111",
      "name": "ุดุฑูุฉ BThwani"
    }
  }
]
```

### ูุซุงู 3: ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงููุฑูุน

```typescript
// Request
GET /branches/stats
Authorization: Bearer <access_token>

// Response
{
  "totalBranches": 5,
  "activeBranches": 4,
  "inactiveBranches": 1,
  "totalUsers": 50,
  "totalWarehouses": 10,
  "branchesByCompany": {
    "ุดุฑูุฉ BThwani": 5
  }
}
```

---

## ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

### 409 Conflict - ููุฏ ุงููุฑุน ููุฌูุฏ ุจุงููุนู
**ุงูุณุจุจ**: ูุญุงููุฉ ุฅูุดุงุก ูุฑุน ุจููุฏ ููุฌูุฏ

**ุงูุญู**: 
- ุงุณุชุฎุฏุงู ููุฏ ูุฑุน ุขุฎุฑ
- ุฃู ุชุญุฏูุซ ุงููุฑุน ุงูููุฌูุฏ

---

### 404 Not Found - ุงูุดุฑูุฉ ุบูุฑ ููุฌูุฏุฉ
**ุงูุณุจุจ**: ูุนุฑู ุงูุดุฑูุฉ ุงููุฑุณู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู**: 
- ุงูุชุญูู ูู ุตุญุฉ ูุนุฑู ุงูุดุฑูุฉ
- ุฅูุดุงุก ุงูุดุฑูุฉ ุฃููุงู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ

---

### 404 Not Found - ุงููุฏูุฑ ุบูุฑ ููุฌูุฏ
**ุงูุณุจุจ**: ูุนุฑู ุงููุฏูุฑ ุงููุฑุณู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู**: 
- ุงูุชุญูู ูู ุตุญุฉ ูุนุฑู ุงููุฏูุฑ
- ุฅูุดุงุก ุงููุณุชุฎุฏู ุฃููุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู

---

### 400 Bad Request - ูุง ูููู ุญุฐู ุงููุฑุน
**ุงูุณุจุจ**: ุงููุฑุน ูุฑุชุจุท ุจุจูุงูุงุช ุฃุฎุฑู (ูุณุชุฎุฏูููุ ูุฎุงุฒูุ ููุงุชูุฑ)

**ุงูุญู**: 
- ุฅูุบุงุก ุชูุนูู ุงููุฑุน ุจุฏูุงู ูู ุญุฐูู
- ุฃู ุญุฐู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุฃููุงู

---

**๐ ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ**: ุฏูุณูุจุฑ 2025
**๐จโ๐ป ุงููุทูุฑ**: ูุฑูู ุชุทููุฑ BThwani
**๐ ุฅุตุฏุงุฑ ุงููุญุฏุฉ**: v1.0.0

