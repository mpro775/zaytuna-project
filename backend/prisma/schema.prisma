// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// 1. نماذج البنية الأساسية (Infrastructure Models)
// =============================================================================

// معلومات الشركة
model Company {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  address     String?  @db.Text
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(255)
  taxNumber   String?  @db.VarChar(100)
  isActive    Boolean  @default(true)

  branches Branch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("companies")
}

// الفروع
model Branch {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  code        String   @unique @db.VarChar(50)
  address     String?  @db.Text
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(255)
  managerId   String?  @db.VarChar(50)
  companyId   String   @db.VarChar(50)
  isActive    Boolean  @default(true)

  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users       User[]
  warehouses  Warehouse[]
  managers    User[]    @relation("BranchManager")
  salesInvoices SalesInvoice[]
  auditLogs   AuditLog[] // سجلات التدقيق
  syncBatches SyncBatch[] // دفعات المزامنة
  paymentTransactions PaymentTransaction[] // معاملات الدفع
  notifications Notification[] // الإشعارات

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("branches")
  @@index([companyId])
}

// المخازن
model Warehouse {
  id        String  @id @default(cuid()) @db.VarChar(50)
  name      String  @db.VarChar(255)
  code      String  @unique @db.VarChar(50)
  address   String? @db.Text
  phone     String? @db.VarChar(50)
  email     String? @db.VarChar(255)
  managerId String? @db.VarChar(50)
  branchId  String  @db.VarChar(50)
  isActive  Boolean @default(true)

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  manager User? @relation(fields: [managerId], references: [id], onDelete: SetNull)

  stockItems StockItem[]
  stockMovements StockMovement[]
  salesInvoices SalesInvoice[]
  salesInvoiceLines SalesInvoiceLine[]
  returns Return[]
  returnLines ReturnLine[]
  purchaseOrders PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  auditLogs AuditLog[] // سجلات التدقيق

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
  @@index([branchId])
  @@index([managerId])
}

// الأدوار والصلاحيات
model Role {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  permissions Json     @default("[]")
  isSystemRole Boolean @default(false)
  isActive    Boolean  @default(true)

  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roles")
}

// المستخدمون والمصادقة
model User {
  id                String    @id @default(cuid()) @db.VarChar(50)
  username          String    @unique @db.VarChar(100)
  email             String    @unique @db.VarChar(255)
  phone             String?   @db.VarChar(50)
  passwordHash      String    @db.VarChar(255)
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  branchId          String?   @db.VarChar(50)
  roleId            String    @db.VarChar(50)
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?   @db.VarChar(255)
  biometricEnabled  Boolean   @default(false)

  branch Branch? @relation(fields: [branchId], references: [id])
  role   Role    @relation(fields: [roleId], references: [id])
  managedWarehouses Warehouse[]
  managedBranches   Branch[]   @relation("BranchManager")
  salesInvoices     SalesInvoice[] // ككاشير
  payments          Payment[]      // كمعالج للمدفوعات
  returns           Return[]       // كمعالج للمرتجعات
  purchaseOrders    PurchaseOrder[] // كطالب لأوامر الشراء
  purchaseInvoices  PurchaseInvoice[] // كمستلم للفواتير
  purchasePayments  PurchasePayment[] // كمعالج لمدفوعات المشتريات
  journalEntries    JournalEntry[] // كمنشئ للقيود اليومية
  auditLogs         AuditLog[] // سجلات التدقيق
  syncBatches       SyncBatch[] // دفعات المزامنة
  paymentTransactions PaymentTransaction[] // معاملات الدفع
  sentNotifications Notification[] @relation("NotificationSender") // الإشعارات المرسلة
  notificationPreferences NotificationPreference[] // تفضيلات الإشعارات
  createdNotificationTemplates NotificationTemplate[] // قوالب الإشعارات التي أنشأها

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
  @@index([branchId])
  @@index([roleId])
  @@index([email])
}

// المنتجات والفئات
model Category {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  parentId    String?  @db.VarChar(50)
  imageUrl    String?  @db.Text
  isActive    Boolean  @default(true)

  parent   Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
  @@index([parentId])
}

model Product {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  barcode     String?  @unique @db.VarChar(100)
  sku         String?  @unique @db.VarChar(100)
  categoryId  String   @db.VarChar(50)
  basePrice   Decimal  @db.Decimal(10, 2)
  costPrice   Decimal? @db.Decimal(10, 2)
  taxId       String?  @db.VarChar(50)
  isActive    Boolean  @default(true)
  trackInventory Boolean @default(true)
  reorderPoint   Int?     @default(0)
  imageUrl    String?  @db.Text

  category      Category      @relation(fields: [categoryId], references: [id])
  tax           Tax?          @relation(fields: [taxId], references: [id])
  variants      ProductVariant[]
  purchaseOrderLines PurchaseOrderLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
  @@index([categoryId])
  @@index([barcode])
  @@index([sku])
}

model ProductVariant {
  id          String   @id @default(cuid()) @db.VarChar(50)
  productId   String   @db.VarChar(50)
  name        String   @db.VarChar(255)
  sku         String?  @unique @db.VarChar(100)
  barcode     String?  @unique @db.VarChar(100)
  price       Decimal? @db.Decimal(10, 2)
  costPrice   Decimal? @db.Decimal(10, 2)
  weight      Decimal? @db.Decimal(8, 3)
  dimensions  Json?    // {length, width, height}
  attributes  Json?    // {color, size, material, etc}
  imageUrl    String?  @db.Text
  isActive    Boolean  @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockItems StockItem[]
  stockMovements StockMovement[]
  salesInvoiceLines SalesInvoiceLine[]
  returnLines ReturnLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_variants")
  @@index([productId])
  @@index([sku])
  @@index([barcode])
}

// عناصر المخزون
model StockItem {
  id                String  @id @default(cuid()) @db.VarChar(50)
  warehouseId       String  @db.VarChar(50)
  productVariantId  String  @db.VarChar(50)
  quantity          Decimal @db.Decimal(10, 3)
  minStock          Decimal @default(0) @db.Decimal(10, 3)
  maxStock          Decimal @default(1000) @db.Decimal(10, 3)

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  movements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([warehouseId, productVariantId])
  @@map("stock_items")
  @@index([warehouseId])
  @@index([productVariantId])
}

// حركات المخزون
model StockMovement {
  id                String   @id @default(cuid()) @db.VarChar(50)
  warehouseId       String   @db.VarChar(50)
  productVariantId  String   @db.VarChar(50)
  movementType      String   @db.VarChar(50) // in, out, adjustment, transfer
  quantity          Decimal  @db.Decimal(10, 3)
  referenceType     String?  @db.VarChar(50) // sales, purchase, adjustment, transfer
  referenceId       String?  @db.VarChar(50)
  reason            String?  @db.Text
  performedBy       String?  @db.VarChar(50) // User ID

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  stockItem StockItem @relation(fields: [warehouseId, productVariantId], references: [warehouseId, productVariantId], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("stock_movements")
  @@index([warehouseId])
  @@index([productVariantId])
  @@index([referenceType])
  @@index([referenceId])
}

// العملاء والعملات والضرائب
model Customer {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(255)
  address     String?  @db.Text
  taxNumber   String?  @db.VarChar(100)
  creditLimit Decimal? @db.Decimal(10, 2)

  // نظام الولاء
  loyaltyPoints         Int      @default(0)
  loyaltyTier          String   @default("bronze") @db.VarChar(20) // bronze, silver, gold, platinum
  totalPurchases       Decimal  @default(0) @db.Decimal(12, 2)
  lastPurchaseDate     DateTime?
  preferredPaymentMethod String? @db.VarChar(50)

  // معلومات شخصية إضافية
  birthday             DateTime?
  gender               String?  @db.VarChar(10) // male, female, other
  marketingConsent     Boolean  @default(false)

  isActive    Boolean  @default(true)

  salesInvoices SalesInvoice[]
  payments      Payment[]
  returns       Return[]
  creditNotes   CreditNote[]
  paymentTransactions PaymentTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
  @@index([email])
  @@index([phone])
  @@index([loyaltyTier])
  @@index([lastPurchaseDate])
}

model Currency {
  id          String   @id @default(cuid()) @db.VarChar(50)
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(255)
  symbol      String?  @db.VarChar(10)
  exchangeRate Decimal @db.Decimal(10, 6)
  isBase      Boolean  @default(false)
  isActive    Boolean  @default(true)

  salesInvoices SalesInvoice[]
  payments      Payment[]
  returns       Return[]
  creditNotes   CreditNote[]
  purchaseInvoices PurchaseInvoice[]
  purchasePayments PurchasePayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("currencies")
  @@index([code])
}

model Tax {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  rate        Decimal  @db.Decimal(5, 2)
  isActive    Boolean  @default(true)

  products     Product[]
  salesInvoices SalesInvoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("taxes")
}

// فواتير المبيعات والمدفوعات
model SalesInvoice {
  id              String   @id @default(cuid()) @db.VarChar(50)
  invoiceNumber   String   @unique @db.VarChar(50)
  branchId        String   @db.VarChar(50)
  customerId      String?  @db.VarChar(50)
  cashierId       String   @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)

  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(10, 2)

  currencyId      String   @db.VarChar(50)
  taxId           String?  @db.VarChar(50)

  status          String   @default("draft") @db.VarChar(50) // draft, confirmed, cancelled, refunded
  paymentStatus   String   @default("pending") @db.VarChar(50) // pending, partial, paid, refunded

  notes           String?  @db.Text
  dueDate         DateTime?

  branch          Branch       @relation(fields: [branchId], references: [id])
  customer        Customer?    @relation(fields: [customerId], references: [id])
  cashier         User         @relation(fields: [cashierId], references: [id])
  warehouse       Warehouse    @relation(fields: [warehouseId], references: [id])
  currency        Currency     @relation(fields: [currencyId], references: [id])
  tax             Tax?         @relation(fields: [taxId], references: [id])

  lines           SalesInvoiceLine[]
  payments        Payment[]
  returns         Return[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sales_invoices")
  @@index([branchId])
  @@index([customerId])
  @@index([cashierId])
  @@index([warehouseId])
  @@index([status])
  @@index([paymentStatus])
  @@index([invoiceNumber])
}

model SalesInvoiceLine {
  id              String   @id @default(cuid()) @db.VarChar(50)
  salesInvoiceId  String   @db.VarChar(50)
  productVariantId String  @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)

  quantity        Decimal  @db.Decimal(10, 3)
  unitPrice       Decimal  @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  lineTotal       Decimal  @db.Decimal(10, 2)

  salesInvoice    SalesInvoice   @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)
  productVariant  ProductVariant @relation(fields: [productVariantId], references: [id])
  warehouse       Warehouse      @relation(fields: [warehouseId], references: [id])

  createdAt DateTime @default(now())

  @@map("sales_invoice_lines")
  @@index([salesInvoiceId])
  @@index([productVariantId])
  @@index([warehouseId])
}

model Payment {
  id              String   @id @default(cuid()) @db.VarChar(50)
  salesInvoiceId  String?  @db.VarChar(50)
  customerId      String?  @db.VarChar(50)
  currencyId      String   @db.VarChar(50)

  amount          Decimal  @db.Decimal(10, 2)
  paymentMethod   String   @db.VarChar(50) // cash, card, bank_transfer, check, digital_wallet
  referenceNumber String?  @db.VarChar(100)
  notes           String?  @db.Text

  paymentDate     DateTime @default(now())
  processedBy     String?  @db.VarChar(50) // User ID

  salesInvoice    SalesInvoice? @relation(fields: [salesInvoiceId], references: [id])
  customer        Customer?     @relation(fields: [customerId], references: [id])
  currency        Currency      @relation(fields: [currencyId], references: [id])
  processor       User?         @relation(fields: [processedBy], references: [id])

  @@map("payments")
  @@index([salesInvoiceId])
  @@index([customerId])
  @@index([currencyId])
  @@index([paymentMethod])
}

// المرتجعات وإشعارات الدائن
model Return {
  id              String   @id @default(cuid()) @db.VarChar(50)
  returnNumber    String   @unique @db.VarChar(50)
  salesInvoiceId  String   @db.VarChar(50)
  customerId      String?  @db.VarChar(50)
  cashierId       String   @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)

  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(10, 2)

  currencyId      String   @db.VarChar(50)
  reason          String   @db.Text

  status          String   @default("draft") @db.VarChar(50) // draft, confirmed, cancelled, refunded
  refundStatus    String   @default("pending") @db.VarChar(50) // pending, partial, refunded

  notes           String?  @db.Text

  salesInvoice    SalesInvoice @relation(fields: [salesInvoiceId], references: [id])
  customer        Customer?    @relation(fields: [customerId], references: [id])
  cashier         User         @relation(fields: [cashierId], references: [id])
  warehouse       Warehouse    @relation(fields: [warehouseId], references: [id])
  currency        Currency     @relation(fields: [currencyId], references: [id])

  lines           ReturnLine[]
  creditNotes     CreditNote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("returns")
  @@index([salesInvoiceId])
  @@index([customerId])
  @@index([cashierId])
  @@index([warehouseId])
  @@index([status])
  @@index([refundStatus])
  @@index([returnNumber])
}

model ReturnLine {
  id              String   @id @default(cuid()) @db.VarChar(50)
  returnId        String   @db.VarChar(50)
  productVariantId String  @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)

  quantity        Decimal  @db.Decimal(10, 3)
  unitPrice       Decimal  @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  lineTotal       Decimal  @db.Decimal(10, 2)

  reason          String?  @db.Text

  return          Return       @relation(fields: [returnId], references: [id], onDelete: Cascade)
  productVariant  ProductVariant @relation(fields: [productVariantId], references: [id])
  warehouse       Warehouse    @relation(fields: [warehouseId], references: [id])

  createdAt DateTime @default(now())

  @@map("return_lines")
  @@index([returnId])
  @@index([productVariantId])
  @@index([warehouseId])
}

model CreditNote {
  id              String   @id @default(cuid()) @db.VarChar(50)
  creditNoteNumber String  @unique @db.VarChar(50)
  returnId        String   @db.VarChar(50)
  customerId      String?  @db.VarChar(50)
  currencyId      String   @db.VarChar(50)

  amount          Decimal  @db.Decimal(10, 2)
  remainingAmount Decimal  @db.Decimal(10, 2)

  status          String   @default("active") @db.VarChar(50) // active, used, expired, cancelled
  expiryDate      DateTime?

  notes           String?  @db.Text

  return          Return     @relation(fields: [returnId], references: [id])
  customer        Customer?  @relation(fields: [customerId], references: [id])
  currency        Currency   @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("credit_notes")
  @@index([returnId])
  @@index([customerId])
  @@index([currencyId])
  @@index([status])
  @@index([creditNoteNumber])
}

// الموردين وأوامر وفواتير المشتريات
model Supplier {
  id          String   @id @default(cuid()) @db.VarChar(50)
  name        String   @db.VarChar(255)
  contactName String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(255)
  address     String?  @db.Text
  taxNumber   String?  @db.VarChar(100)
  paymentTerms String? @db.VarChar(255) // شروط الدفع
  isActive    Boolean  @default(true)

  purchaseOrders   PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  purchasePayments PurchasePayment[]
  paymentTransactions PaymentTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("suppliers")
  @@index([email])
  @@index([phone])
}

model PurchaseOrder {
  id              String   @id @default(cuid()) @db.VarChar(50)
  orderNumber     String   @unique @db.VarChar(50)
  supplierId      String   @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)
  requestedBy     String   @db.VarChar(50) // User ID

  expectedDate    DateTime?
  notes           String?  @db.Text

  status          String   @default("draft") @db.VarChar(50) // draft, approved, ordered, received, cancelled

  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  warehouse       Warehouse  @relation(fields: [warehouseId], references: [id])
  requester       User       @relation(fields: [requestedBy], references: [id])

  lines           PurchaseOrderLine[]
  purchaseInvoices PurchaseInvoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_orders")
  @@index([supplierId])
  @@index([warehouseId])
  @@index([status])
  @@index([orderNumber])
}

model PurchaseOrderLine {
  id              String   @id @default(cuid()) @db.VarChar(50)
  purchaseOrderId String   @db.VarChar(50)
  productId       String   @db.VarChar(50)

  quantity        Decimal  @db.Decimal(10, 3)
  unitCost        Decimal  @db.Decimal(10, 2)

  receivedQuantity Decimal @default(0) @db.Decimal(10, 3)

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())

  @@map("purchase_order_lines")
  @@index([purchaseOrderId])
  @@index([productId])
}

model PurchaseInvoice {
  id              String   @id @default(cuid()) @db.VarChar(50)
  invoiceNumber   String   @unique @db.VarChar(50)
  supplierId      String   @db.VarChar(50)
  warehouseId     String   @db.VarChar(50)
  receivedBy      String   @db.VarChar(50) // User ID
  purchaseOrderId String?  @db.VarChar(50)

  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(10, 2)

  currencyId      String   @db.VarChar(50)

  invoiceDate     DateTime @default(now())
  dueDate         DateTime?

  status          String   @default("draft") @db.VarChar(50) // draft, received, approved, paid, cancelled
  paymentStatus   String   @default("pending") @db.VarChar(50) // pending, partial, paid

  notes           String?  @db.Text

  supplier        Supplier        @relation(fields: [supplierId], references: [id])
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id])
  receiver        User            @relation(fields: [receivedBy], references: [id])
  purchaseOrder   PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])
  currency        Currency        @relation(fields: [currencyId], references: [id])

  lines           PurchaseInvoiceLine[]
  payments        PurchasePayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_invoices")
  @@index([supplierId])
  @@index([warehouseId])
  @@index([purchaseOrderId])
  @@index([status])
  @@index([paymentStatus])
  @@index([invoiceNumber])
}

model PurchaseInvoiceLine {
  id                String   @id @default(cuid()) @db.VarChar(50)
  purchaseInvoiceId String   @db.VarChar(50)
  productVariantId  String   @db.VarChar(50)
  warehouseId       String   @db.VarChar(50)

  quantity          Decimal  @db.Decimal(10, 3)
  unitCost          Decimal  @db.Decimal(10, 2)
  discountAmount    Decimal  @default(0) @db.Decimal(10, 2)
  taxAmount         Decimal  @default(0) @db.Decimal(10, 2)
  lineTotal         Decimal  @db.Decimal(10, 2)

  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id])
  warehouse         Warehouse       @relation(fields: [warehouseId], references: [id])

  createdAt DateTime @default(now())

  @@map("purchase_invoice_lines")
  @@index([purchaseInvoiceId])
  @@index([productVariantId])
  @@index([warehouseId])
}

model PurchasePayment {
  id                String   @id @default(cuid()) @db.VarChar(50)
  purchaseInvoiceId String   @db.VarChar(50)
  supplierId        String   @db.VarChar(50)
  currencyId        String   @db.VarChar(50)

  amount            Decimal  @db.Decimal(10, 2)
  paymentMethod     String   @db.VarChar(50) // cash, bank_transfer, check, credit_card
  referenceNumber   String?  @db.VarChar(100)
  notes             String?  @db.Text

  paymentDate       DateTime @default(now())
  processedBy       String?  @db.VarChar(50) // User ID

  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id])
  supplier          Supplier        @relation(fields: [supplierId], references: [id])
  currency          Currency        @relation(fields: [currencyId], references: [id])
  processor         User?           @relation(fields: [processedBy], references: [id])

  @@map("purchase_payments")
  @@index([purchaseInvoiceId])
  @@index([supplierId])
  @@index([currencyId])
  @@index([paymentMethod])
}

// النظام المحاسبي الأساسي
model GLAccount {
  id          String   @id @default(cuid()) @db.VarChar(50)
  accountCode String   @unique @db.VarChar(20) // رقم الحساب
  name        String   @db.VarChar(255)
  description String?  @db.Text
  accountType String   @db.VarChar(50) // asset, liability, equity, revenue, expense

  parentId    String?  @db.VarChar(50)
  parent      GLAccount? @relation("GLAccountHierarchy", fields: [parentId], references: [id])
  children    GLAccount[] @relation("GLAccountHierarchy")

  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // حساب نظامي لا يمكن حذفه

  // الأرصدة
  debitBalance  Decimal @default(0) @db.Decimal(15, 2)
  creditBalance Decimal @default(0) @db.Decimal(15, 2)

  // القيود المتعلقة بهذا الحساب
  debitEntries  JournalEntryLine[] @relation("DebitAccount")
  creditEntries JournalEntryLine[] @relation("CreditAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gl_accounts")
  @@index([accountCode])
  @@index([accountType])
  @@index([parentId])
}

model JournalEntry {
  id              String   @id @default(cuid()) @db.VarChar(50)
  entryNumber     String   @unique @db.VarChar(20) // رقم القيد
  entryDate       DateTime @default(now())
  description     String   @db.Text
  referenceType   String?  @db.VarChar(50) // sale, purchase, payment, adjustment, etc
  referenceId     String?  @db.VarChar(50) // ID المرجع
  sourceModule    String?  @db.VarChar(50) // sales, purchasing, inventory, etc

  status          String   @default("draft") @db.VarChar(20) // draft, posted, reversed
  isSystem        Boolean  @default(false) // قيد تم إنشاؤه تلقائياً

  totalDebit      Decimal  @default(0) @db.Decimal(15, 2)
  totalCredit     Decimal  @default(0) @db.Decimal(15, 2)

  createdBy       String?  @db.VarChar(50) // User ID
  creator         User?    @relation(fields: [createdBy], references: [id])

  lines           JournalEntryLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("journal_entries")
  @@index([entryNumber])
  @@index([entryDate])
  @@index([referenceType])
  @@index([referenceId])
  @@index([status])
  @@index([sourceModule])
}

model JournalEntryLine {
  id              String   @id @default(cuid()) @db.VarChar(50)
  journalEntryId  String   @db.VarChar(50)
  lineNumber      Int      @default(1)

  // حساب المدين
  debitAccountId  String   @db.VarChar(50)
  debitAccount    GLAccount @relation("DebitAccount", fields: [debitAccountId], references: [id])

  // حساب الدائن
  creditAccountId String   @db.VarChar(50)
  creditAccount   GLAccount @relation("CreditAccount", fields: [creditAccountId], references: [id])

  // المبلغ
  amount          Decimal  @db.Decimal(15, 2)
  description     String?  @db.Text

  // المرجع
  referenceType   String?  @db.VarChar(50)
  referenceId     String?  @db.VarChar(50)

  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("journal_entry_lines")
  @@index([journalEntryId])
  @@index([debitAccountId])
  @@index([creditAccountId])
  @@index([referenceType])
  @@index([referenceId])
}

// =============================================================================
// 5. نماذج التكاملات والنظام (Integration & System Models)
// =============================================================================

// سجلات التدقيق
model AuditLog {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // المستخدم الذي قام بالعملية
  userId          String?  @db.VarChar(50)
  user            User?    @relation(fields: [userId], references: [id])

  // نوع العملية
  action          String   @db.VarChar(50) // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc

  // الكيان المُعدّل
  entity          String   @db.VarChar(100) // Product, Sale, Customer, etc

  // معرف الكيان
  entityId        String   @db.VarChar(50)

  // الفرع (إن وجد)
  branchId        String?  @db.VarChar(50)
  branch          Branch?  @relation(fields: [branchId], references: [id])

  // المخزن (إن وجد)
  warehouseId     String?  @db.VarChar(50)
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id])

  // تفاصيل العملية
  details         Json?    // بيانات إضافية عن العملية
  oldValues       Json?    // القيم القديمة (لعمليات التحديث والحذف)
  newValues       Json?    // القيم الجديدة (لعمليات الإنشاء والتحديث)

  // معلومات النظام
  ipAddress       String?  @db.VarChar(45)  // IPv4 أو IPv6
  userAgent       String?  @db.Text
  sessionId       String?  @db.VarChar(100)

  // حالة العملية
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text

  // تصنيف العملية
  severity        String   @default("info") @db.VarChar(20) // info, warning, error, critical
  category        String   @default("business") @db.VarChar(50) // business, security, system, audit

  // المراجع
  referenceType   String?  @db.VarChar(50) // sale, purchase, payment, etc
  referenceId     String?  @db.VarChar(50)

  // الوحدة النظامية
  module          String?  @db.VarChar(50) // sales, inventory, accounting, etc

  // وقت العملية
  timestamp       DateTime @default(now())

  // معلومات إضافية للبحث والفلترة
  searchableText  String?  @db.Text // نص قابل للبحث يحتوي على معلومات مهمة

  createdAt DateTime @default(now())

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([branchId])
  @@index([warehouseId])
  @@index([timestamp])
  @@index([success])
  @@index([severity])
  @@index([category])
  @@index([referenceType])
  @@index([referenceId])
  @@index([module])
  @@index([searchableText])
}

// دفعات المزامنة
model SyncBatch {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // معلومات الدفعة
  batchId         String   @unique @db.VarChar(100) // معرف فريد للدفعة
  deviceId        String   @db.VarChar(100) // معرف الجهاز المُرسل
  branchId        String?  @db.VarChar(50)
  branch          Branch?  @relation(fields: [branchId], references: [id])

  // نوع المزامنة
  syncType        String   @db.VarChar(50) // full, incremental, changes_only
  direction       String   @db.VarChar(20) // upload, download, bidirectional

  // حالة المزامنة
  status          String   @default("pending") @db.VarChar(20) // pending, processing, completed, failed, conflicted

  // إحصائيات الدفعة
  totalRecords    Int      @default(0)
  processedRecords Int     @default(0)
  failedRecords   Int      @default(0)
  conflictedRecords Int    @default(0)

  // بيانات المزامنة
  changes         Json?    // التغييرات المُرسلة
  conflicts       Json?    // التعارضات المكتشفة
  resolution      Json?    // كيفية حل التعارضات

  // معلومات إضافية
  metadata        Json?    // بيانات إضافية للمزامنة
  errorMessage    String?  @db.Text

  // الطوابع الزمنية
  createdAt       DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  lastSyncAt      DateTime?

  // معلومات الإصدار
  clientVersion   String?  @db.VarChar(50)
  serverVersion   String?  @db.VarChar(50)

  // الأولوية والإعادة
  priority        Int      @default(0)
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)

  createdBy       String?  @db.VarChar(50) // User ID
  creator         User?    @relation(fields: [createdBy], references: [id])

  @@map("sync_batches")
  @@index([batchId])
  @@index([deviceId])
  @@index([branchId])
  @@index([status])
  @@index([syncType])
  @@index([direction])
  @@index([createdAt])
  @@index([lastSyncAt])
}

// معاملات الدفع
model PaymentTransaction {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // معلومات المعاملة الأساسية
  transactionId   String   @unique @db.VarChar(100) // معرف المعاملة من بوابة الدفع
  invoiceId       String   @db.VarChar(50) // ربط بفاتورة المبيعات أو المشتريات
  invoiceType     String   @db.VarChar(20) // sales, purchase

  // معلومات العميل والفرع
  branchId        String?  @db.VarChar(50)
  branch          Branch?  @relation(fields: [branchId], references: [id])
  customerId      String?  @db.VarChar(50)
  customer        Customer? @relation(fields: [customerId], references: [id])
  supplierId      String?  @db.VarChar(50)
  supplier        Supplier? @relation(fields: [supplierId], references: [id])

  // معلومات الدفع
  gateway         String   @db.VarChar(50) // stripe, paypal, tap, local
  method          String   @db.VarChar(50) // card, wallet, bank_transfer, cash
  currency        String   @db.VarChar(3)  // SAR, USD, EUR
  amount          Decimal  @default(0) @db.Decimal(15, 2)
  fee             Decimal  @default(0) @db.Decimal(15, 2) // رسوم البوابة

  // حالة المعاملة
  status          String   @default("pending") @db.VarChar(20) // pending, processing, completed, failed, cancelled, refunded, partially_refunded

  // معلومات البطاقة/المحفظة (مشفرة)
  cardLast4       String?  @db.VarChar(4)
  cardBrand       String?  @db.VarChar(20)
  walletProvider  String?  @db.VarChar(50)

  // معلومات إضافية
  description     String?  @db.Text
  metadata        Json?    // بيانات إضافية من البوابة
  gatewayResponse Json?    // استجابة البوابة الكاملة

  // معلومات الأمان
  ipAddress       String?  @db.VarChar(45)
  userAgent       String?  @db.Text

  // معلومات المستخدم
  processedBy     String?  @db.VarChar(50) // User ID
  processor       User?    @relation(fields: [processedBy], references: [id])

  // الطوابع الزمنية
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  completedAt     DateTime?
  refundedAt      DateTime?

  // معلومات الاسترداد
  refundAmount    Decimal  @default(0) @db.Decimal(15, 2)
  refundReason    String?  @db.Text
  refundMetadata  Json?

  // معلومات التسوية
  settledAt       DateTime?
  settlementAmount Decimal @default(0) @db.Decimal(15, 2)
  settlementFee   Decimal  @default(0) @db.Decimal(15, 2)

  // المراجع الخارجية
  externalId      String?  @db.VarChar(100) // معرف خارجي من البوابة
  batchId         String?  @db.VarChar(100) // معرف دفعة المعالجة

  @@map("payment_transactions")
  @@index([transactionId])
  @@index([invoiceId])
  @@index([invoiceType])
  @@index([branchId])
  @@index([customerId])
  @@index([supplierId])
  @@index([gateway])
  @@index([method])
  @@index([status])
  @@index([createdAt])
  @@index([processedAt])
  @@index([completedAt])
}

// الإشعارات والرسائل
model Notification {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // معلومات الإشعار الأساسية
  title           String   @db.VarChar(255)
  message         String   @db.Text
  type            String   @db.VarChar(50) // email, sms, whatsapp, push, in_app

  // المستلم
  recipientId     String?  @db.VarChar(50) // User ID أو Customer ID أو Supplier ID
  recipientType   String   @db.VarChar(20) // user, customer, supplier, admin
  recipientEmail  String?  @db.VarChar(255)
  recipientPhone  String?  @db.VarChar(50)

  // حالة الإشعار
  status          String   @default("pending") @db.VarChar(20) // pending, sent, delivered, failed, cancelled

  // معلومات الإرسال
  provider        String?  @db.VarChar(50) // twilio, sendgrid, whatsapp_business, firebase
  providerMessageId String? @db.VarChar(100) // معرف الرسالة من مزود الخدمة
  sentAt          DateTime?
  deliveredAt     DateTime?
  failedAt        DateTime?

  // معلومات الأولوية والجدولة
  priority        String   @default("normal") @db.VarChar(20) // low, normal, high, urgent
  scheduledAt     DateTime?
  expiresAt       DateTime?

  // معلومات إضافية
  templateId      String?  @db.VarChar(50) // ربط بقالب الإشعار
  template        NotificationTemplate? @relation(fields: [templateId], references: [id])

  // البيانات الديناميكية للقالب
  data            Json?    // البيانات المستخدمة في القالب

  // معلومات الاستجابة والتفاعل
  responseData    Json?    // استجابة مزود الخدمة
  clickedAt       DateTime?
  readAt          DateTime?

  // معلومات النظام
  module          String?  @db.VarChar(50) // sales, inventory, payment, audit
  event           String?  @db.VarChar(50) // invoice_created, payment_received, stock_low
  referenceId     String?  @db.VarChar(50) // معرف الكيان المرتبط
  referenceType   String?  @db.VarChar(50) // sales_invoice, payment_transaction, etc

  // معلومات المرسل
  sentBy          String?  @db.VarChar(50) // User ID
  sender          User?    @relation("NotificationSender", fields: [sentBy], references: [id])

  // معلومات الفرع
  branchId        String?  @db.VarChar(50)
  branch          Branch?  @relation(fields: [branchId], references: [id])

  // محاولات الإرسال
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  lastError       String?  @db.Text

  // الطوابع الزمنية
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("notifications")
  @@index([recipientId])
  @@index([recipientType])
  @@index([status])
  @@index([type])
  @@index([provider])
  @@index([priority])
  @@index([scheduledAt])
  @@index([module])
  @@index([event])
  @@index([createdAt])
  @@index([sentAt])
}

// قوالب الإشعارات
model NotificationTemplate {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // معلومات القالب الأساسية
  name            String   @unique @db.VarChar(100)
  description     String?  @db.Text
  type            String   @db.VarChar(50) // email, sms, whatsapp, push, in_app

  // محتوى القالب
  subject         String?  @db.VarChar(255) // للإيميل والدفع
  content         String   @db.Text // المحتوى الرئيسي
  htmlContent     String?  @db.Text // للإيميل (HTML)

  // المتغيرات المتاحة
  variables       Json?    // قائمة المتغيرات المتاحة في القالب

  // إعدادات القالب
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false) // القالب الافتراضي لنوع الحدث

  // معلومات اللغة والتوطين
  language        String   @default("ar") @db.VarChar(10)
  locale          String   @default("ar-SA") @db.VarChar(10)

  // معلومات الحدث المرتبط
  event           String   @db.VarChar(50) // نوع الحدث (invoice_created, payment_received)
  module          String   @db.VarChar(50) // الوحدة (sales, inventory, payment)

  // إعدادات الإرسال
  priority        String   @default("normal") @db.VarChar(20)
  channels        Json?    // القنوات المسموحة ['email', 'sms', 'whatsapp']

  // معلومات النظام
  createdBy       String?  @db.VarChar(50) // User ID
  creator         User?    @relation(fields: [createdBy], references: [id])

  // الإشعارات المستخدمة لهذا القالب
  notifications   Notification[]

  // الطوابع الزمنية
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("notification_templates")
  @@index([name])
  @@index([type])
  @@index([event])
  @@index([module])
  @@index([language])
  @@index([isActive])
}

// تفضيلات الإشعارات للمستخدمين
model NotificationPreference {
  id              String   @id @default(cuid()) @db.VarChar(50)

  // المستخدم المالك
  userId          String   @db.VarChar(50)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // نوع الإشعار
  notificationType String  @db.VarChar(50) // email, sms, whatsapp, push, in_app
  event            String  @db.VarChar(50) // نوع الحدث

  // التفضيلات
  enabled         Boolean  @default(true)
  frequency       String   @default("immediate") @db.VarChar(20) // immediate, daily, weekly, monthly
  quietHoursStart String?  @db.VarChar(5) // وقت بدء الهدوء (HH:MM)
  quietHoursEnd   String?  @db.VarChar(5) // وقت نهاية الهدوء (HH:MM)

  // الطوابع الزمنية
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, notificationType, event])
  @@map("notification_preferences")
  @@index([userId])
  @@index([notificationType])
  @@index([event])
  @@index([enabled])
}
